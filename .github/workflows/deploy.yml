name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      # 1. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
      - name: Check secrets
        env:
          HAS_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}
          HAS_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID != '' }}
        run: |
          echo "Has BOT_TOKEN: $HAS_BOT_TOKEN"
          echo "Has CHAT_ID: $HAS_CHAT_ID"
          if [ "$HAS_BOT_TOKEN" = "false" ] || [ "$HAS_CHAT_ID" = "false" ]; then
            echo "âš ï¸ Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ: ÐÐµ Ð²ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹!"
            echo "Ð§Ñ‚Ð¾Ð±Ñ‹ Ñ„Ð¾Ñ€Ð¼Ð° Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð»Ð°, Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ:"
            echo "1. TELEGRAM_BOT_TOKEN Ð² Settings â†’ Secrets and variables â†’ Actions"
            echo "2. TELEGRAM_CHAT_ID Ð² Settings â†’ Secrets and variables â†’ Actions"
          else
            echo "âœ… Ð’ÑÐµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ñ‹"
          fi
      
      # 3. Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹
      - name: Replace tokens in HTML files
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ”§ Ð—Ð°Ð¼ÐµÐ½ÑÑŽ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹ Ð² HTML Ñ„Ð°Ð¹Ð»Ð°Ñ…..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Python ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¼ÐµÐ½Ñ‹
          cat > replace_tokens.py << 'EOF'
          import os
          import re
          
          bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
          chat_id = os.environ.get('TELEGRAM_CHAT_ID', '')
          
          print(f"Ð¢Ð¾ÐºÐµÐ½ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: {'Ð”Ð°' if bot_token else 'ÐÐµÑ‚'} (Ð´Ð»Ð¸Ð½Ð°: {len(bot_token)})")
          print(f"Chat ID Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½: {'Ð”Ð°' if chat_id else 'ÐÐµÑ‚'}")
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          files_to_process = []
          for filename in ['forms.html', 'index.html', 'admin.html']:
              if os.path.exists(filename):
                  files_to_process.append(filename)
          
          print(f"ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸: {len(files_to_process)}")
          
          for filename in files_to_process:
              print(f"\nÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÑŽ Ñ„Ð°Ð¹Ð»: {filename}")
              try:
                  with open(filename, 'r', encoding='utf-8') as file:
                      content = file.read()
                  
                  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ð¾Ð²
                  token_before = "TELEGRAM_BOT_TOKEN_PLACEHOLDER" in content
                  chat_before = "TELEGRAM_CHAT_ID_PLACEHOLDER" in content
                  
                  # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹
                  content = content.replace('TELEGRAM_BOT_TOKEN_PLACEHOLDER', bot_token)
                  content = content.replace('TELEGRAM_CHAT_ID_PLACEHOLDER', chat_id)
                  
                  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð·Ð°Ð¼ÐµÐ½Ñƒ
                  token_after = "TELEGRAM_BOT_TOKEN_PLACEHOLDER" in content
                  chat_after = "TELEGRAM_CHAT_ID_PLACEHOLDER" in content
                  
                  with open(filename, 'w', encoding='utf-8') as file:
                      file.write(content)
                      
                  print(f"  âœ… Ð—Ð°Ð¼ÐµÐ½Ð° Ñ‚Ð¾ÐºÐµÐ½Ð°: {'Ð”Ð° â†’ ÐÐµÑ‚' if token_before and not token_after else 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾'}")
                  print(f"  âœ… Ð—Ð°Ð¼ÐµÐ½Ð° chat_id: {'Ð”Ð° â†’ ÐÐµÑ‚' if chat_before and not chat_after else 'ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾'}")
                  
              except Exception as e:
                  print(f"  âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ñ„Ð°Ð¹Ð»Ð° {filename}: {e}")
          EOF
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚
          python replace_tokens.py
      
      # 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð°Ð¼ÐµÐ½Ñ‹
      - name: Verify replacement
        run: |
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÑŽ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð°Ð¼ÐµÐ½Ñ‹..."
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ forms.html
          if [ -f "forms.html" ]; then
            echo "forms.html:"
            if grep -q "TELEGRAM_BOT_TOKEN_PLACEHOLDER" forms.html || grep -q "TELEGRAM_CHAT_ID_PLACEHOLDER" forms.html; then
              echo "  âŒ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: ÐŸÐ»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹ Ð½Ðµ Ð·Ð°Ð¼ÐµÐ½ÐµÐ½Ñ‹!"
              echo "  ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:"
              echo "  1. ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¹ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð² Ð² GitHub"
              echo "  2. Ð§Ñ‚Ð¾ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ"
              echo "  3. Ð›Ð¾Ð³Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ workflow"
            else
              echo "  âœ… ÐŸÐ»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹ Ð·Ð°Ð¼ÐµÐ½ÐµÐ½Ñ‹"
              
              # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ‚Ð¾ÐºÐµÐ½Ð°
              if grep -q "://api.telegram.org/bot" forms.html; then
                echo "  âœ… ÐÐ°Ð¹Ð´ÐµÐ½ Telegram API URL"
              else
                echo "  âš ï¸ Telegram API URL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
              fi
            fi
          else
            echo "  âŒ Ð¤Ð°Ð¹Ð» forms.html Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
      
      # 5. Ð”ÐµÐ¿Ð»Ð¾Ð¸Ð¼ Ð½Ð° GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
