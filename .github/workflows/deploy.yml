name: Deploy to GitHub Pages
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
permissions:
  contents: write
  pages: write
  id-token: write
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      # 1. ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
      - name: Check secrets
        env:
          HAS_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}
          HAS_CHAT_ID: ${{ secrets.TEGRAM_CHAT_ID != '' }}
        run: |
          echo "Checking secrets configuration:"
          echo "Has BOT_TOKEN: $HAS_BOT_TOKEN"
          echo "Has CHAT_ID: $HAS_CHAT_ID"
          
          if [ "$HAS_BOT_TOKEN" = "false" ] || [ "$HAS_CHAT_ID" = "false" ]; then
            echo "âš ï¸ WARNING: Not all secrets are configured!"
            echo "To make the form work, add:"
            echo "1. TELEGRAM_BOT_TOKEN in Settings â†’ Secrets and variables â†’ Actions"
            echo "2. TELEGRAM_CHAT_ID in Settings â†’ Secrets and variables â†’ Actions"
            exit 1
          else
            echo "âœ… All secrets are configured correctly"
          fi
      
      # 3. Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹ Ð½Ð° Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ ÑÐµÐºÑ€ÐµÑ‚Ñ‹
      - name: Replace tokens in HTML files
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "ðŸ”§ Replacing placeholders in HTML files..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Python ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð·Ð°Ð¼ÐµÐ½Ñ‹
          cat > replace_tokens.py << 'EOF'
import os
import glob

bot_token = os.environ.get('TELEGRAM_BOT_TOKEN', '')
chat_id = os.environ.get('TELEGRAM_CHAT_ID', '')

print(f"Bot token received: {'Yes' if bot_token else 'No'} (length: {len(bot_token) if bot_token else 0})")
print(f"Chat ID received: {'Yes' if chat_id else 'No'}")

# Ð˜Ñ‰ÐµÐ¼ HTML Ñ„Ð°Ð¹Ð»Ñ‹ Ð²Ð¾ Ð²ÑÐµÑ… Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑÑ…
html_files = []
for root, dirs, files in os.walk('.'):
    for file in files:
        if file.endswith('.html'):
            html_files.append(os.path.join(root, file))

print(f"\nFound {len(html_files)} HTML files to process:")
for file in html_files:
    print(f"  - {file}")

processed_files = 0
for file_path in html_files:
    print(f"\nProcessing file: {file_path}")
    
    try:
        # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð°
        with open(file_path, 'r', encoding='utf-8') as file:
            content = file.read()
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ð¾Ð²
        has_token_placeholder = 'TELEGRAM_BOT_TOKEN_PLACEHOLDER' in content
        has_chat_placeholder = 'TELEGRAM_CHAT_ID_PLACEHOLDER' in content
        
        print(f"  Placeholders found - Token: {has_token_placeholder}, Chat ID: {has_chat_placeholder}")
        
        if has_token_placeholder or has_chat_placeholder:
            # Ð—Ð°Ð¼ÐµÐ½ÑÐµÐ¼ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ñ‹
            new_content = content.replace('TELEGRAM_BOT_TOKEN_PLACEHOLDER', bot_token)
            new_content = new_content.replace('TELEGRAM_CHAT_ID_PLACEHOLDER', chat_id)
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¼ÐµÐ½Ñ‹
            still_has_token = 'TELEGRAM_BOT_TOKEN_PLACEHOLDER' in new_content
            still_has_chat = 'TELEGRAM_CHAT_ID_PLACEHOLDER' in new_content
            
            print(f"  After replacement - Token placeholder remains: {still_has_token}, Chat ID placeholder remains: {still_has_chat}")
            
            # Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð¸ Ð·Ð°Ð¼ÐµÐ½Ñ‹
            if new_content != content:
                with open(file_path, 'w', encoding='utf-8') as file:
                    file.write(new_content)
                print(f"  âœ… Successfully replaced placeholders in {file_path}")
                processed_files += 1
            else:
                print(f"  âš ï¸ No changes made to {file_path}")
        else:
            print(f"  â„¹ï¸ No placeholders found in {file_path}")
            
    except Exception as e:
        print(f"  âŒ Error processing {file_path}: {str(e)}")

print(f"\nâœ… Replacement completed. Processed {processed_files} files with replacements.")
EOF

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚
          python replace_tokens.py
      
      # 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð°Ð¼ÐµÐ½Ñ‹
      - name: Verify replacement
        run: |
          echo "ðŸ” Verifying replacement results..."
          
          # Ð˜Ñ‰ÐµÐ¼ Ð²ÑÐµ HTML Ñ„Ð°Ð¹Ð»Ñ‹
          html_files=$(find . -name "*.html")
          
          echo "Checking for remaining placeholders in HTML files:"
          found_placeholders=false
          
          for file in $html_files; do
            if grep -q "TELEGRAM_BOT_TOKEN_PLACEHOLDER" "$file" || grep -q "TELEGRAM_CHAT_ID_PLACEHOLDER" "$file"; then
              echo "  âŒ File $file still contains placeholders!"
              found_placeholders=true
            else
              echo "  âœ… File $file has no placeholders"
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð² Ñ„Ð°Ð¹Ð»Ðµ
            if grep -q "://api.telegram.org/bot" "$file"; then
              echo "    âœ… Telegram API URL found in $file"
            fi
          done
          
          if [ "$found_placeholders" = true ]; then
            echo "  âš ï¸ WARNING: Some files still contain placeholders"
            echo "  This will prevent the form from working correctly"
            # ÐÐµ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ, Ð½Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ
          fi
      
      # 5. Ð”ÐµÐ¿Ð»Ð¾Ð¸Ð¼ Ð½Ð° GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
