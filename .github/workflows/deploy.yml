name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ (–í–û–¢ –ó–î–ï–°–¨ –ò–°–ü–†–ê–í–ò–õ!)
      - name: Check secrets
        env:
          HAS_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}
          HAS_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID != '' }}  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û!
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è—é —Å–µ–∫—Ä–µ—Ç—ã..."
          echo "HAS_BOT_TOKEN: $HAS_BOT_TOKEN"
          echo "HAS_CHAT_ID: $HAS_CHAT_ID"
          
          if [ "$HAS_BOT_TOKEN" = "false" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö GitHub!"
            echo "–î–æ–±–∞–≤—å—Ç–µ –≤ Settings ‚Üí Secrets and variables ‚Üí Actions:"
            echo "–ò–º—è: TELEGRAM_BOT_TOKEN"
            echo "–ó–Ω–∞—á–µ–Ω–∏–µ: –≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞"
            exit 1
          fi
          
          if [ "$HAS_CHAT_ID" = "false" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: TELEGRAM_CHAT_ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö GitHub!"
            echo "–î–æ–±–∞–≤—å—Ç–µ –≤ Settings ‚Üí Secrets and variables ‚Üí Actions:"
            echo "–ò–º—è: TELEGRAM_CHAT_ID"
            echo "–ó–Ω–∞—á–µ–Ω–∏–µ: –≤–∞—à_chat_id"
            exit 1
          fi
          
          echo "‚úÖ –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞–π–¥–µ–Ω—ã"
      
      # 3. –ó–∞–º–µ–Ω—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã (–í–û–¢ –ó–î–ï–°–¨ –ò–°–ü–†–ê–í–ò–õ!)
      - name: Replace tokens in HTML files
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û!
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "üîß –ù–∞—á–∏–Ω–∞—é –∑–∞–º–µ–Ω—É –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤..."
          echo "–¢–æ–∫–µ–Ω: ${TELEGRAM_BOT_TOKEN:0:10}..."  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
          echo "Chat ID: $TELEGRAM_CHAT_ID"
          
          # –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —á–µ—Ä–µ–∑ sed (–Ω–∞–¥–µ–∂–Ω–µ–µ)
          echo "–ó–∞–º–µ–Ω—è—é –≤ forms.html..."
          
          if [ -f "forms.html" ]; then
            # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
            cp forms.html forms.html.backup
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤
            if grep -q "TELEGRAM_BOT_TOKEN_PLACEHOLDER" forms.html; then
              echo "–ù–∞–π–¥–µ–Ω TELEGRAM_BOT_TOKEN_PLACEHOLDER, –∑–∞–º–µ–Ω—è—é..."
              sed -i "s/TELEGRAM_BOT_TOKEN_PLACEHOLDER/$TELEGRAM_BOT_TOKEN/g" forms.html
            else
              echo "‚ö†Ô∏è TELEGRAM_BOT_TOKEN_PLACEHOLDER –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ forms.html"
            fi
            
            if grep -q "TELEGRAM_CHAT_ID_PLACEHOLDER" forms.html; then
              echo "–ù–∞–π–¥–µ–Ω TELEGRAM_CHAT_ID_PLACEHOLDER, –∑–∞–º–µ–Ω—è—é..."
              # –î–ª—è chat_id –Ω—É–∂–Ω–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª—ç—à–∏
              ESCAPED_CHAT_ID=$(echo "$TELEGRAM_CHAT_ID" | sed 's/[\/&]/\\&/g')
              sed -i "s/TELEGRAM_CHAT_ID_PLACEHOLDER/$ESCAPED_CHAT_ID/g" forms.html
            else
              echo "‚ö†Ô∏è TELEGRAM_CHAT_ID_PLACEHOLDER –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ forms.html"
            fi
            
            echo "‚úÖ –ó–∞–º–µ–Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–º–µ–Ω—ã:"
            if grep -q "TELEGRAM_BOT_TOKEN_PLACEHOLDER" forms.html || grep -q "TELEGRAM_CHAT_ID_PLACEHOLDER" forms.html; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–µ –∑–∞–º–µ–Ω–µ–Ω—ã!"
              echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª..."
              cp forms.html.backup forms.html
              exit 1
            else
              echo "‚úÖ –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–º–µ–Ω–µ–Ω—ã"
            fi
          else
            echo "‚ùå –§–∞–π–ª forms.html –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          fi
      
      # 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–º–µ–Ω—ã
      - name: Verify replacement
        run: |
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–º–µ–Ω—ã..."
          
          if [ -f "forms.html" ]; then
            echo "forms.html:"
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –Ω–µ—Ç
            if grep -q "TELEGRAM_BOT_TOKEN_PLACEHOLDER\|TELEGRAM_CHAT_ID_PLACEHOLDER" forms.html; then
              echo "‚ùå –û–®–ò–ë–ö–ê: –í forms.html –æ—Å—Ç–∞–ª–∏—Å—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã!"
              echo "–ü–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å –æ—à–∏–±–∫–æ–π:"
              grep -n "TELEGRAM_BOT_TOKEN_PLACEHOLDER\|TELEGRAM_CHAT_ID_PLACEHOLDER" forms.html | head -5
              exit 1
            else
              echo "‚úÖ –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∑–∞–º–µ–Ω–µ–Ω—ã"
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–æ–±–∞–≤–ª–µ–Ω
              if grep -q "8245036915:AAGSCr2wt1WicMVx2jZlVeAxSsPa3CbuWjU" forms.html; then
                echo "‚úÖ –ù–∞–π–¥–µ–Ω –≤–∞—à —Ç–æ–∫–µ–Ω –≤ forms.html"
              elif grep -q "://api.telegram.org/bot" forms.html; then
                echo "‚úÖ –ù–∞–π–¥–µ–Ω Telegram API URL"
                echo "–¢–æ–∫–µ–Ω (–ø–µ—Ä–≤—ã–µ 15 —Å–∏–º–≤–æ–ª–æ–≤):"
                grep -o 'const BOT_TOKEN = "[^"]*' forms.html | head -c 30
                echo "..."
              else
                echo "‚ö†Ô∏è Telegram —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ forms.html"
              fi
            fi
          fi
      
      # 5. –î–µ–ø–ª–æ–∏–º –Ω–∞ GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          publish_branch: gh-pages
          force_orphan: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
